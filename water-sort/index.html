<!doctype html>
<title>Water Sort</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width">
<style>
html, body {
    background: #222222;
    font-family: sans-serif;
    height: 100%;
    margin: 0;
    overflow: hidden;
    text-align: center;
    width: 100%;
}
h1 {
    color: white;
    margin: 0;
}
button {
    font-size: 150%;
    height: 8%;
    margin: 0.3em;
    width: 25%;
}
</style>

<canvas></canvas>
<h1 id="title"></h1>
<button id="reset">reset</button>
<button id="hint">hint</button>
<button id="undo">undo</button>
<br/>
<button id="prev">prev</button>
<button id="next">next</button>

<script>
const INPUT_NONE  = 0
const INPUT_CLICK = 1
const INPUT_HINT  = 2
const INPUT_RESET = 3
const INPUT_UNDO  = 4

const DRAW_BOX  = 0
const DRAW_FILL = 1

const SEEDS = [
    11250064,  5620088,   712116, 14049914, 15429545, 15387894,  9796048,
     2106783,    18205, 16129999, 12627291, 11928371,  3505285, 16095334,
     3547659,  4949213,   757777, 14010096, 11924358, 12646115,  1448439,
    11913423, 16149816,  4941979, 11193717, 11216427,  1415399,  1425612,
     5640583,  2843358, 15394745,  7001873, 16080779, 10517351, 10496947,
    16140502, 14703752,  5635847, 11247487,  6309460,  1420943,    64518,
    16117222,   775042, 11952399,    48684, 10504120, 13282529,  8428807,
     8415612,   769387,  7016858,  4894722, 13354760,   768242,  7053479,
    12644945,  9091625,  3496593,  1470957,  2156857,  7030441, 13310637,
    10525367, 16148758, 11898465,  4253128,  4953654, 11200485, 11238507,
     8442899, 15436290,  1414714,  7714712, 15425903,  8408292, 12593607,
     9802038,  4202678,  2848374,  7051046, 12627150,  6303832, 14748372,
     8401000,  6308761,   754353, 12617509,  9838400,  4215633, 12612003,
    16142840,  7692292, 11214025,    18008,    33461,  7015074, 12607902,
     3506579,  4257525,  4903927, 11929023,  6996910, 10512334, 12606570,
     7758225, 14693389,  2170411, 14050841,  9809132,  7749027,    15116,
     7013783,  3568492,  2173715,  2134096,    36320, 11197744, 14702108,
    14735958,  4902605,  5615685,  2856088,  2872531,  7696896,  7718991,
    14050750,  2847662, 12586648, 10499878,  9834008, 13993661,  7011040,
     3565394,  2168634, 10493631, 14035732,  3525731, 11234358,  1423016,
     6323549,  6320868, 11219295, 16126165, 11886615, 12618894, 15391399,
    16090880,  8391735,  4946955,   736171, 13341445, 10501451, 11213967,
     2846421,  7031209,  2154239,  5628780,  2826642,  3567316,  1424788,
    15439292,  6357982, 10547918,  5655647, 15393703,  9134026, 16148455,
     6336421, 10513404, 11889434,  1405445,  7040513,  2830362, 12626766,
     6352375,  2806998,    60994,  9859856, 11199097,  8406020,  6326830,
    14022635,  6302966,  5651222,  7012645, 11918866, 13336280,  9789501,
     3522145,  4946864, 12650407,    45371,  9801426, 10491796, 10490654,
    14707326,    43226, 14696032,  6332498, 13995408, 15379880,  4914674,
      723011,   735812,   738524,  8453193,  2846335, 11248271,  6304414,
     1400492,  6333244,  3522042, 11891325, 13356080,  9858957, 15395874,
    11900199,  5639431,  9102764,    22240, 11908214,  1472114,  9136518,
     7741992,  5625049,  9831379,  9800666,  3499946,  7744554,  7021365,
    14039733,  4243143,  1444216, 11891782,  7000370,  4244462, 11935227,
     6332415, 12626430, 10526262, 13313271, 14696207, 14732358,  4238097,
     3531925,  6990622, 16130529, 10534171,  3549679, 11210976, 13981492,
    15418722,  4965270,  3499563,  7698839,  9840974, 12610637, 16120902,
    14694928, 16103723, 11241059,  7024989, 15433436, 16134241, 13350663,
    11187305,  1445760, 13324999, 14045906,  5665275,  9836219, 11236349,
    11949090, 11919636,  9815017,  9135062,  6341782, 11197144,  2809146,
     3542099, 12659868,  8389074, 11244494,  1399964,  1458258,  1444186,
    12640922,  9805226, 16152489,  4230832,  1439360, 11940408, 11241663,
     4933764, 13283027, 15453183,  6318919,  7002675,  2865344, 10561073,
     4895190,  4221432,  4967343,  1424043,  3567453, 14681964,  6350507,
     7753697,  9861715, 12655736, 16082464, 13321425, 14697232,  2827965,
    10505200,  2129573, 16131956,  4899260,  4234772,  9800976,  2130487,
     4946418,  2166186, 12585554,  9100639,  2157853, 11195625,    30704,
     4197358,  2116123,  4917356,  1448588, 13349832,  8396502, 13347978,
    13994599,  3502521,    32657,  9857000, 12620221, 11891581, 11909295,
     3508945,  1443418,  4906831, 10533085,  4965312,  2817737,  4950487,
     1422678,  9845021,  2860972,  2803212,   746982, 12631131, 15416923,
    11185887, 15423145, 11251440,  7701934,  7004182,  9121061,  6353232,
     7733848,  9099588, 11198573,  4226258, 13991631,  1418415,  9096042,
    11203390,  2103257,  9795752, 10486401,  9815643,  2811129,  5597924,
       43294,  2830203,  8436226,  7721599, 16083531,    50663,   759139,
     9155795,  9854817,  6350955, 11903482,  1470191,  1399802,  4243749,
    14003560,  2098683,  7721675, 13339180,  2869526,  2150669,  4924800,
    10493061, 14694392, 14039785, 10491871,  9138633, 13341058,  9138028,
     7753465,  4895921,  2161948, 14018826,  1403192,    15310,    21105,
    11236150,    64427,  7736800,  9090531,    15662,  9860082,  6353091,
    10542968, 16112005,  8444278,  9130887,  3538333,  4205454, 11204854,
     2824810, 14026294, 14726069,   773322, 11957670, 14692290,    50824,
     4223965,  4938383,    38206, 15381279, 11231928, 12635191, 14702770,
     3539189, 11934180,  2105148,  2169086,  3569257,  7032787, 14683186,
    12648795, 10513998, 11913102, 14748687,  2116356, 10497751, 14701528,
     1474621, 12656533,    65469, 13289021, 14693976,  6320558,  3562321,
     2142146,  7023720,  5639820, 11930348, 16091335, 14043811,   700844,
    12606571,  9092390,  9161560, 12645352,  7027969,  9837892,  7023246,
     8422605,  7039829,  8403982,  9111509,  4958114,  4917505,   725530,
     2109387,  4944717, 15428029,  7043949,  6364020,  4233501,  6346587,
    10552532, 13325929,    38271,  8404842,    51759,  9119664,  7696488,
    11915129, 11897157, 13327538, 13357850, 10511662, 15406894, 15409989,
    10538373, 10524697, 13992020,   747472, 13317207,   762230,  3520899,
     1420544, 15382806,  5608097,     5929,   707962,  4239698,  5629247,
     2105522, 15431422,  6998137,  8428791,  9800479,   701401, 10514152,
    14749265,  1469425,  3555371, 11904280,  9855179, 10556124, 10558956,
    14744284, 11898538, 16128140,  7000766, 14682910, 11920902,  7758522,
     7721965,  2167994,  8437270,  7064932,  5626518, 16148439, 11194899,
       29502, 16125267, 14721732, 13329508,  8451325,  4952115,  9844922,
     3496120,   712959,  3544121,  1475081,  1421744, 11196844, 14054381,
    14749981, 14687374,    46901,  2126724, 13291666,  5632121,  7727257,
    11894476, 12612435, 10523066,   753675,    30008,  5638891, 13334734,
     4917635,  3514056,  2139767,  5609996, 15425211,    65027,  6294073,
     2101091,  4199300,  9823682, 13313203,  7734806, 13319209, 14717456,
       53701, 10488337,  9788174,    22255,   709597, 14705281,  4260937,
     7063183,  6336969, 11952753, 11884689,  8456406, 13357194, 14022940,
    11257030,  5661322, 15408436, 15381574, 14044484,  2873241,  4958807,
     7046353,  3511136,  1475033,  4257091,  4251255,  6342623,  7043736,
    16135050,  9138636, 16107910, 15438208,  1412903, 11222332,   764765,
       33812,  6332588, 13992508,  9146488, 14696112,  7025669,  1409802,
     4214955, 10512699,  9161058,  6300574,  9097266,    16068, 13351374,
       42863,  4938178,  9095856,  2108822,  7733853, 11253016, 12606596,
     2801593,  4264275,  5664082,  6297881,  9140596,  7006087, 14021663,
    10548962, 15384350,   768273,  3546523, 16150539, 16113764,  1403344,
    11950149,  1432311, 11253180,  8440050, 16086839, 13309372,    75612,
     5652323,  2100257,  2816655,  9814720, 11243950, 13989760,  9115392,
     9107820,  4228898, 11936685,  4231843, 11246437,  9797143,  2137011,
    14008035,  7032812, 16145224, 11226947, 12648265,    36286,    23468,
     1439461,  2833197,  7005682,  8451585,   699294,  4227972, 16123024,
    11260494, 11925834, 16154483,  2136452,  2860077,    41776,  7727961,
     8439967,  7005216,  5652501,    26671,  5607384, 13348667, 15416941,
      754155,  2809041,  6321325,  6293312,  7709988, 13348158,  2104818,
     4222067, 15426889,  9861526, 16150397,  2804778,  5663028,   768548,
     8458033,  9102579,  7712344, 15405821,  6314339,  7014320, 14732913,
    14015232, 15431201, 13307397,  9790359,  4225834,  1405614, 13312129,
     6334078,  5664165, 11200301, 14741215, 14043448, 11897641,  9802673,
     2817285,   762544, 11942997, 14027451, 14049046,  2124915,  3539305,
     6343259,  8388848,   731381,  6311883,  1465240,  4895175,  1399906,
    14009800,  4953065, 14031367, 15448333,  8417652, 13335932, 12606772,
    11210681,  8416998,  8403071, 11222814, 15426356, 15430549,  2099910,
     9830939,  4237884,  8429710,  1467611, 11212472,  8446379,  3569243,
     2114215, 11917239,   769343, 11233250,  2167271,   731552, 10499811,
     9108614, 14018258,  7035395, 14713347,  2831895,  3554814,   734096,
    14026523, 11946330,  4900620, 11206648,  8430584, 14056997,  4909207,
       33426,  9788443,  9121020, 11253437,  8458794, 11947790,  8445865,
     9150757,  8420649,  7738604,  8453389,   724009, 11212008,  7042522,
     2813338,  1406461,    16018,  7728829, 11944912,  4268606,  6292928,
    14730477, 12585080,  7708107,  2850932,  3542958,  1414053, 16078235,
    13344194,  4200313, 14757432,  9858541, 16079604,  5599502,    50562,
     4237008,  9140992, 14028560,  8438581,  5650775,  2857122, 13293404,
    15400820,  3520696,    12222,  2118978, 13287374,  7718007, 12635956,
     7061532, 14006733, 10552539,  9847275,  7753587,  9099164,  7005490,
    14736652,  2170088,    21107,  7721325, 11897345,  9820519,  1423479,
     5637213, 15405942,  4258637, 13353407,  8456297,  9114422,  3533821,
     4215046, 12632227, 11222582, 14700050,  8421677,  7054493,   774187,
     2098616,  3522496,   722378,  3570628,  4256265, 14690125,  9135538,
     2848952,  4252946, 15442686,    61177,  2864765, 13302424, 11189426,
     9099619,  6332043,  3552115, 15410529,  6311525,  6361000,  9822627,
     7754246,  7000436, 14694494, 14733311, 14681022,  6341683, 12583083,
    10499365,   754775,  4253170,  4962474,  7064077,  5611721, 12625515,
     7752543,  6357442, 16086086,  7717066,  4225006,  9131168,  4943565,
     4900269,  7730875,  9148356, 12635192,  9103559,  7052797,  6361609,
    13348852, 15382390,  4250001,     9519, 14694739, 14011630, 10500451,
     2166503, 10499660,  9828092,  3503483,  5638180, 11945953,  7756140,
     2125602,   750471,   750509, 15455001,  6309549,  8408149, 15434766,
    15411029,  8458861,     9714,  7729967,  6352132,   713120, 13343091,
     3500165,  8436448, 16140655,  5622560,  1472492,  4907765,  4224255,
    14711118,  8418744, 12620324,  9797480,  2832760,  2142181, 16144029,
    10554585,  4926581,  4917938,  2102432, 16118398,  9143330,  4245801,
     9853528, 14756151, 14684793,  4239156,  3517717,  5618566, 16124263,
     2130071, 12601905,  9806045,  1431201,  9122361, 15422388, 11930313,
    10547876, 14690323,  7748750,  4913480,  8433714,    53517,  9148765,
    13338637,  1398807,  2150195,  1446282,  8427615,  6306261,  5632388,
     6332251,  1447702,  2152847, 14751202,    32443,  2834844,  1470363,
     4204135,  4236898, 10509708, 11188147, 14692273, 11927988,   749969,
     4217070, 14032908,  7749401,  7755519, 14745950,  7057460, 11229303,
     9138009,  8408509, 12642198,  1469784, 15448516, 10556856, 12610948,
    11890828,  2828150,  4966908, 10494834, 12639430,  7751250,  9138115,
    12631867, 14691843,  9118831,  7025912,  4922898, 15434183,    54581,
    15449400,  6360010, 15390158,  9091649,  9096569, 15386611,  7714919,
       50876, 12622218,  6314809,  9815285, 11903738,  2107006,  2832099,
     2102390, 10526252,  5638711,  2807986,  7730106,  7059382, 15429079,
     9102617,  8426618,    55690,  1415368,  3522408,  4251580, 11944225,
     2843647, 16085249,  6333510,  8423866, 10527764,    15866, 15439827,
     1401700, 13987690,    14351,  4247651, 14742311,  9836649,  8410792,
     5620480,  1461294, 14052867,  9797387, 12615069, 12618129,  6338223,
     8412489,  8459461,  2152354,  5663516,  9092420, 15403736,  3564673,
     2151402, 10559585,  4223204,  4924665,  4248963,  2804886,  4213674,
    10516424,  4930441,  2149482, 11207671,  9858367,  4950103, 15438620,
     2107547,  2170683,  2861857,  9792818,  4258382,  2800990,  3517431,
     9815270, 14736909,  1465378,  3503612, 15389942, 11909561, 10544406,
     9141586, 14686504,  2112535,  6317654, 11945218,  5613778, 13305628,
    15395915,  2161088,  9856623,  6321593, 10517557,  7052130, 11229810,
     5646967, 16102668, 12595934,  4955379,  7748322,  3520206,  2841446,
     3552324, 16093536, 11940210,  9796572,  2140062, 13328767, 12603027,
     4927340,   748782,  7748070,  8395661,  4264035,   763634, 15401638,
    11234812, 15453145, 12609469,  4252524,  4198692,    24362,  3552368,
     7701831, 16116254,    48301, 12623007, 11919154,  7726962,  7053429,
      723010,  1430129,  3529558, 10541192,  6997351,  2164335, 14051349,
     7046026, 14707663,  9795895,  2838074, 11908186, 14711021,  2162882,
     6312656, 13343216,  3517214,  4260807,  8402727,    22288, 12630933,
    16089160,  7029570,  3551820,  6345018,  3500855,  4927494,  8451258,
    12590832, 14718249,  8437586,     2892,  6996834, 11936045, 11884586,
    11904010,  6328457,  2161728,   743066, 13343781,  1414125,  3535523,
     7019457, 10535120,  1417440,  1419113, 12610183,  3547255,  2822514,
     6317309, 14030875,  9137589,  3536466, 14051166,  8394238,  3497482,
    13347476,  9156515,  9122070, 10546513,  9099250,  9805297, 14002645,
     6327484, 15427918,    17576, 12644966,  8414813,    38302,  9849928,
    14721584, 13312405,  1445759, 13332930, 14693276,  9813901,    50512,
     7731080, 16126436,   724538, 16139283,  1473345,  4929388, 11191630,
     6998346,  5626425, 11937143,  4251688, 12656843,   741739, 13291985,
    15397550, 16127583, 15452278,   715094,  6312810,  4267408,   716673,
     6311936,  3555380,  2109563,  3524362,  4266579,  4919242,  3553851,
    14684521, 11241858,  4954795,  3570303,  9822053,  9844149, 11945128,
     7692773,  5599448,  2808963,  2813463,   715005,  7694233, 14017908,
     4230853, 14035429,    63329,  3526126, 14033341,  4242863,  4957090,
     2817891, 10548081,  7698754, 13990883,   725579,  7039073,  9139646,
    16148756,  2803910,   725497, 10503310,  4945328,  9160562,  4953178,
     4224175,  1429523, 11256960,  7061797, 13320678,  2816955,  6346751,
    11906572, 12612840,    37494,  7737048,  4261335, 14030178,  3545576,
    14020701,  3500385,  2113880,  2154500, 14753125,  6365002, 14681038,
     6301244, 12604924, 16118987,  4222075,  9819263,  1440430,  4220215,
    13337238,  7763608, 12595391,    15216,  8429965,  2863934, 11894781,
    15402499,  1447675,    46178, 11950509,   718606, 16099322, 16115714,
     7752581, 13313185,  4943344, 13312155, 11243052,  8455371,  4262584,
    14709689,  1402980,  2804455,  8402789,  9110078, 13335030,  6349311,
     1426759,  5637447, 14043979, 15403472,  7040587,  2868009, 13351766,
     2802084,  6301456,  3539488, 12608209,    27917,  4940848,  8450799,
    13355005,  9793261,  5599760, 11950469, 13992799,  4210727,  3513084,
     7044686, 14727470, 10506379,  8462361,  6296418,  3514267,  4923649,
     2102938, 11201532, 13336124,  5619710,  9789797,  9101018, 11204452,
    11220437,   709510,    25459,  3530794, 11958899,  8396279,   702398,
     4914478,  9812388, 14687886, 10496209, 11918391, 11948092,  9798973,
     2868241,  2113418,  3525896,  2871559,  2845984, 14716980, 16104852,
    15409925, 11238309,  2864002,  7059213, 11935490, 12621213,  4244020,
    15441137,  2167338,   743814,  6357839,  2858413,  6306304,  2117155,
    10489986, 10519159,  2128390, 11959086, 16084251,  5618219,  2810164,
     7026933, 14689470,  3543031,    30084, 12626373, 13340731, 16078596,
     7756734, 14057730,  9790622,  9147723, 14043725,  1436093,  4237674,
     9807008,  1427832,  3561719, 12611890,    32869,  4238208,  2806067,
     1443920,    24104,  3499203, 11921892,    43869, 16095348,  4949656,
       69103,  4963408, 11930504,  9845614, 10496893,  7034028, 15398048,
      737875,  5642182,  8400723,  8440002,  2834779,  2140180,  4212059,
     9829841,  4928646, 11933096,  9154872,  4198741, 11211884,    11304,
     7732023, 11888870, 11211185,  1458982,  7754791, 11891250,  2136034,
    16127094, 14756963,  8411293, 14717282,  7747302,  9161371,  4248094,
    15397379,    21991, 16106530, 10501047,    30080,  7756119,  9161650,
    12611409, 16151770, 16145981,    46619, 15404814,  2800559,  7728514,
    14057691, 10509197,  2144038, 16147924, 15402594, 15406879,  4207191,
    14740991,  3557353,  4898129,  2808433, 15398724,  9813422,  1437574,
     5604337,  1442983,  9861297,  3515382,  3528273,  3511306, 13305622,
     7030622,  4263040,  7722021, 10493750,  2153550, 11909692,  9858044,
     4908113,  2160306, 12589259, 14705378, 14018652,  2128653,  1464802,
     2105970,  8402696,  7727028, 13300695,   771761,  6347557, 13282285,
       69034, 14058483, 13986206,  2143448, 11954347, 14004307,  3526233,
     3539357,  4931095,  6363098,   706196, 11199587,  6337474, 10539920,
     2820392, 15392105,  7709728, 15422328, 14704532,  8428353, 11235392,
    16093833,  1420439,  5652626, 11900132,  7749015,  5663796, 12595971,
     3543168,  9137414, 11898257, 10534971, 10545591,    28416,  9818171,
     1435085, 10547986, 13324152, 15434995, 11188815,  2131494, 11226781,
     5622076,  9088274,  2117865, 11928578,  4910128,  7023330,  4929238,
    10538155,    74510, 16154349,  1403498,  7005848, 11925566,  7738885,
     4897945, 15396772,   717139,  8407856, 16101220,  7032726,  2148077,
     7690111, 16134012,  4954814,  5623040,  9830185,  2843299,  2838450,
    12633796, 10522877,  4240644, 14742431,  3498403, 16142954, 14696131,
     4249018,  9120584,  2154284,  6346864,  4910024,  2127207,  7020264,
    15422403, 11195963, 14720079,    16352,  8455274,  7691591,  8399862,
     4232915,  3561342, 12626772,  5624010, 14716848,  5607243,  4942956,
    13309235,  3568830,  1401604,  1418509, 11217601,  2835282, 14717681,
     2849459,  1458058,  1439659, 14041082, 11922391, 16142834,  4213659,
       44043, 14748511,  5643966, 13333983,  5601409, 11896128,  4912665,
     9109154,  9155918,    35270,  1425300,  4255139, 14690005, 12604204,
     4247126,  2871069,    28639,  8438237,   772853,    39868, 15388957,
     1412879,  9138535,  5661451,  9137556, 14737316,  4263925,    21948,
     2123404,  9134993, 13352046, 13355946, 12660256, 12604417,  4227426,
     4956652, 16101136,  5649022,  1459404, 10502144, 16114844,  9152211,
      770621,  4946492, 15401879,   716554, 13308564,   752823,  1416283,
    14755877,  7037928,  9155235, 16079176, 15380251, 10539290, 16083316,
     4938931,  2806439,  9854101,  5641558, 12624995,  3524500, 10494716,
     1424640, 16090703,  2155726, 12597028,  4918590, 11949142, 11218295,
     2858280, 11946067,  5662044,  3567389, 13983403, 11206045,  6338714,
     4242704,  7749955,  7758664, 12613838, 10551206,  7735441, 12606410,
    10531722,  5665447,  2149651, 14739856, 15436215, 12586397, 14717301,
     9812949, 13291850,   726605,  7724082,  7030353, 10499485,  9143539,
     2837825, 14699900,  7708665,    50971,  9789203, 11251652, 16151655,
      719892, 10527042, 11245174, 15427914,  7735224, 11257933, 13355987,
    14722407,  7746514,  9815200, 11253388,  9831687,    67792, 15431156,
     9789739,  8408257, 11927467, 10532549,  2154327, 11953539, 12594696,
     2140367,    14826,  6327102,  2836578, 13331020,  2800720,  8445263,
     4951040,    70851, 15393340,   700209, 16143034,  8423695,  6298625,
    15406468,  3559655, 14750975,  7719203, 10497808, 11954309, 11249096,
    13990155,  3514814,  2145057,  9159380,  1398199, 13288945, 12592628,
    11902510,  9158879,  9819451,  3559445,  2162824, 13288958,  1424721,
     1472515, 16097797,    14633, 16110177,  4932807,  2155008,    18881,
    11935541,  6361458,  4228809, 15406537,  4249430, 14719747, 11953434,
     7706881, 14018260,  5601601, 14051862,  9825060, 11230072,  7706452,
     7049169, 15429528, 15397672,  2111187,  2814415, 14742492, 12638910,
     2845364,  2857502,  9849251, 10529906,  2845339,  7030055,  5633936,
     7723506, 14031109,  7028617,   749805, 10540682,   735259,  1462036,
    13292367, 13998243, 13286697, 10527424, 14727377,  6296472, 12638739,
     2121364,  4935555,  7058771,  4966806,  9135868,  8458938,  4919692,
    15395680,  2804218,  2133615, 15397637,    43143,  7693510,  9150717,
    14757415,  2135278,  2811547, 16094900,  1435419,  8443259,  8422767,
    14736655, 15407280, 11893450,  5621028,  4963969,  2850257, 11908964,
    11252154,  9155788,  6342548, 11212728,  6309698,  7754345,  9149232,
     9157593,  7036987, 11899207, 15416699, 12609576, 12645016, 12629738,
     5652448, 13282062, 14039482, 13304901,  4912174,  5615794,  2103068,
     4215610,  2139923,  7697005, 12603386,  9139460,  7751174, 11231116,
     7019731, 14737242, 12660618,  2168869,  8439384,  9158850, 15404166,
     7719164,   707468, 12654302,  3526847, 15389808,  4241403,  7021081,
    10511074, 13301289,  7761079,  8460489,  1470647, 12614889,   703479,
    13983728,  4209326,  2822360,  2174400,  9852221,  2168627, 14017556,
     6323707,  4244568, 13324586,  6303983,  9860623, 14049530,  9823660,
    13303892,  9133611, 13328302, 11940078,  4915122,  8418038, 10552263,
    11232119, 14037814,  6341783,  3502439,  8427498,  9850855,  8451353,
    16082215, 11906122,  9150462,  4223042,  5617219
]

async function load() {
    let response = await fetch("water-sort.wasm")
    let bytes    = await response.arrayBuffer()
    let module   = await WebAssembly.compile(bytes)
    let wasm     = await WebAssembly.instantiate(module)
    return wasm.exports
}

async function main() {
    let exports = await load()
    let title   = document.querySelector("#title")
    let canvas  = document.querySelector("canvas")
    let ctx     = canvas.getContext("2d")
    let memory  = exports.memory
    let start   = Date.now()
    let mousex  = -1
    let mousey  = -1

    function now() {
        return Date.now() - start
    }

    function render() {
        let width  = canvas.width  = window.innerWidth
        let height = canvas.height = width
        let ptr    = exports.game_render(width, height, mousex, mousey)
        let dl     = new Int32Array(memory.buffer, ptr)
        let active = dl[0]
        let len    = dl[1]
        let ops    = dl.subarray(2)

        for (let i = 0; i < len; i++) {
            let op    = ops.subarray(6*i, 6*i+6)
            let style = `#${op[1].toString(16).padStart(6, "0")}`
            switch (op[0]) {
            case DRAW_BOX:
                ctx.strokeStyle = style
                ctx.strokeRect(op[2], op[3], op[4], op[5])
                break
            case DRAW_FILL:
                ctx.fillStyle = style
                ctx.fillRect(op[2], op[3], op[4], op[5])
                break
            }
        }

        if (active >= 0) {
            canvas.style.cursor = "pointer"
        } else {
            canvas.style.cursor = "auto"
        }
    }

    canvas.addEventListener("mousemove", function(e) {
        mousex = e.clientX
        mousey = e.clientY
    })

    canvas.addEventListener("contextmenu", function(e) {
        e.preventDefault()
    })

    canvas.addEventListener("mousedown", function(e) {
        mousex = e.clientX
        mousey = e.clientY
        switch (e.button) {
        case 0: exports.game_update(INPUT_CLICK, mousex, mousey, now())
                break
        case 1: exports.game_update(INPUT_HINT, mousex, mousey, now())
                break
        case 2: exports.game_update(INPUT_UNDO, mousex, mousey, now())
                break
        }
    })

    document.addEventListener("keydown", function(e) {
        if (e.key == "u") {
            exports.game_update(INPUT_UNDO, mousex, mousey, now())
        } else if (e.key == "h") {
            exports.game_update(INPUT_HINT, mousex, mousey, now())
        } else if (e.key == "r") {
            exports.game_update(INPUT_RESET, mousex, mousey, now())
        }
    })

    document.querySelector("#reset").addEventListener("click", function(e) {
        exports.game_update(INPUT_RESET, mousex, mousey, now())
    })
    document.querySelector("#hint").addEventListener("click", function(e) {
        exports.game_update(INPUT_HINT, mousex, mousey, now())
    })
    document.querySelector("#undo").addEventListener("click", function(e) {
        exports.game_update(INPUT_UNDO, mousex, mousey, now())
    })

    function getlevel() {
        let level = window.localStorage["level"]
        return level ? parseFloat(level) : 0
    }

    function settitle(level) {
        title.textContent = `puzzle ${level+1}`
    }

    function setlevel(level) {
        window.localStorage["level"] = level
        exports.game_init(SEEDS[level])
        settitle(level)
    }

    document.querySelector("#prev").addEventListener("click", function(e) {
        let level = getlevel()
        level = (level + SEEDS.length - 1) % SEEDS.length
        setlevel(level)
    })
    document.querySelector("#next").addEventListener("click", function(e) {
        let level = getlevel()
        level = (level + 1) % SEEDS.length
        setlevel(level)
    })

    canvas.addEventListener("touchstart", function(e) {
        e.preventDefault()
        let touch = e.touches[e.touches.length - 1]
        mousex = touch.clientX
        mousey = touch.clientY
    })
    canvas.addEventListener("touchmove", function(e) {
        e.preventDefault()
        let touch = e.touches[e.touches.length - 1]
        mousex = touch.clientX
        mousey = touch.clientY
    })
    canvas.addEventListener("touchend", function(e) {
        e.preventDefault()
        if (mousex>=0 && mousey>=0) {
            exports.game_update(INPUT_CLICK, mousex, mousey, now())
        }
        mousex = mousey = -1
    })

    function animate() {
        // TODO: stop requesting frames when state is static
        window.requestAnimationFrame(animate)
        exports.game_update(INPUT_NONE, mousex, mousey, now())
        render()
    }
    window.requestAnimationFrame(animate)

    setlevel(getlevel())
}

main()
</script>
